function [cluster, Z] = asc(X, k, L, I, ON, OC, OS)

%%%%%%%%%%%%ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?%%%%%%%%%%%%%
% input: X---data(N x p);
%        clusterZ--ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(k x p)ï¿½ï¿½
%        L---ï¿½ï¿½Ò»ï¿½Îµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¿ï¿½ï¿½ÔºÏ²ï¿½ï¿½Ä¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Äµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
%        I---ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
%        ON--Ã¿Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä¿ï¿½ï¿½
%        OC--ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö®ï¿½ï¿½ï¿½ï¿½ï¿½Ð¡ï¿½ï¿½ï¿½ë£¬Ð¡ï¿½Ú¸Ã¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÐºÏ²ï¿½ï¿½ï¿½
%        OS--Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö²ï¿½ï¿½Ä±ï¿½×¼ï¿½î£»
%        NO--
% output: cluster ---- Ã¿ï¿½ï¿½ï¿½ï¿½ï¿½Øµï¿½ï¿½ï¿½ï¿?1 x Nï¿½ï¿½ï¿½ï¿½
%         Z ---- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(* x p),ï¿½ï¿½ï¿½ï¿½*ï¿½ï¿½Ê¾ï¿½ï¿½ï¿½ÕµÄ¾ï¿½ï¿½ï¿½ï¿½ï¿½
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï?  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
X=hyperNormalize(X);
s=size(X,1);
cluster=zeros(1,s); % ï¿½ï¿½Ê±ï¿½Õ¼ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½
iter=0;
final=0;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  1.ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% k=size(clusterZ,1);  %        k---Ô¤ï¿½ÚµÄ¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
Z=inicializa_centros(X,k);
% Z = clusterZ;



%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½Òªï¿½ï¿½ï¿½ï¿½  %
%%%%%%%%%%%%%%%%%%%%%%%%

while final==0   %ï¿½ï¿½ï¿½ï¿½Ñ­ï¿½ï¿½ï¿½ï¿½ï¿?
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%  3.ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½Ã¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä£ï¿½Xï¿½ï¿½Yï¿½ï¿½  %
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	for i=1:s
        cluster(i)=cercano(X(i,:), Z);
    end
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%  4.É¾ï¿½ï¿½Èºï¿½ï¿½  %
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Òªï¿½ï¿½ï¿½Ä¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä¿ï¿½Í·ï¿½ï¿½Ö¡ï¿½
    [Z, cluster]=eliminar(cluster, Z, X, ON);
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%  5.ï¿½ï¿½ï¿½ï¿½Èºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½  %
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	Z=recalcula(cluster, X, Z);
    
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%  6.ï¿½ï¿½ó£¬·ï¿½ï¿½Ñ»ï¿½Ï²ï¿½  %
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    if (iter==I)
        final=1;
        next=0;
	else
        next=decide78(iter, k, size(Z,1));
    end


	%%%%%%%%%%%%%%%
	%  7.ï¿½ï¿½ï¿½ï¿½  %
	%%%%%%%%%%%%%%%
	if next==1
        next=2;  %Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ£ï¿½ï¿½ï¿½Ã´ï¿½ï¿½ï¿½ï¿½Ò»ï¿½Îºï¿½Í·ï¿½ï¿½ØµÚ¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ã»ï¿½Ð·ï¿½ï¿½ï¿½ï¿½ï¿½Ñ£ï¿½ï¿½ï¿½Ö±ï¿½Ó½ï¿½ï¿½ï¿½Ï²ï¿½ï¿½ï¿½ï¿??
        hubo_division=0;
        A=size(Z,1);
        % ï¿½ï¿½ï¿½ï¿½Ã¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Äµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ë£¬ï¿½Üµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ë£¬ï¿½ï¿½×¼Æ«ï¿½ï¿½
        
        [Di, D, STM]= dispersion(X, Z, cluster);
	
        % ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä¸ï¿½ï¿½ï¿½ï¿½ï¿½Ð·ï¿½ï¿½ï¿?
		i=0;    % ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÑºÍµï¿½ï¿?                         
		while (hubo_division==0) && (i < A)      % ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä³ï¿½ï¿?...                                     
		    i=i+1;                                                                                      
		    index=find(cluster==i); % indexï¿½ï¿½Ê¾Èºï¿½ï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½      
		    sindex=size(index,2);                                                                                                                                                   
		    if  (STM(i)>OS) && (((Di(i)>D) && (sindex>(2*(ON+1)))) || (A<=(k/2)) ) 
		        hubo_division=1;                                                                        
		        next=1;                                                                                 
		        [Z, cluster]=dividir(STM, cluster, Z, i, X);    % ï¿½ï¿½ï¿½ï¿½.                                                       
		        iter=iter+1;                                                                            
            end                                                                                         
        end                                                                                            
    end

    
	%%%%%%%%%%%%%%%
	%  8.ï¿½Ï²ï¿½  %
	%%%%%%%%%%%%%%%
	if  next==2
        %ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½LÖ®ï¿½ï¿½ï¿½ï¿½ï¿½Ì¾ï¿½ï¿½ë¡£
        [orden, Dij]= distancia_centros(Z, OC, L);   %ï¿½ï¿½ï¿? orden==0 ï¿½ï¿½Ã»ï¿½ï¿½Ê²Ã´ï¿½Ï²ï¿½ï¿½ï¿½.
        % ï¿½Ï²ï¿½ï¿½Ä¼ï¿½Èºï¿½ï¿½
        if  orden(1) > 0
            [cluster, Z]=union(orden, cluster, Z, Dij);
            % ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
            Z=recalcula(cluster, X, Z);
        end
    end
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%  9.ï¿½ï¿½Ö¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ­ï¿½ï¿½  %
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	if (next==2)
        if (iter==I)
            final=1;
        end
        iter=iter+1;
%         [iter,final,vuelve3]= termina_o_itera(iter, I, NO);
    end
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½Ö¹Ñ­ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ­ï¿½ï¿½ï¿½ê£©  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
end   
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ã²»ï¿½ï¿½ï¿½ï¿½ï¿½Ð¡ï¿½ï¿½ï¿½ï¿?  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% for j=1:s
%     temp=0;
%     P=X(j,:);
%     for i=1:A
%         if (distancia(P,Z(i,:)) > min)
%             temp=temp+1;
%         end
%     end
%     if  temp==A
%         cluster(j)=0;
%     end
% end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Kï¿½ï¿½Ö±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä£Ê½K %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Xcluster=0;
% Ycluster=0;
% for m=1:k
%     inedx=0;
%     index=find(cluster==m);
%     s2=size(index,2);
%     for n=1:s2
%         Xcluster(1,n,m)= X(index(n));
%         Ycluster(1,n,m)= Y(index(n));
%     end
% end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                     ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½                        %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %              ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½Ãµï¿½ï¿½Óºï¿½ï¿½ï¿½                 %%  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½Ëºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ã¿ï¿½ï¿½ï¿½ï¿½Ó½ï¿½ï¿½ï¿½ï¿½ÄµÄµï¿?  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [m] = cercano(data, Z)
    dtemp=0;
    for j=1:size(Z,1)
        d=distancia(Z(j,:), data); % ï¿½ï¿½ï¿½ï¿½ï¿½Äµï¿½ï¿½ï¿½ï¿½ï¿½ë¡?
        if j<2
            m=j;    % ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð§ï¿½Ä¡ï¿½
            dtemp=d;
        elseif d < dtemp
            m=j;    %ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ó¦ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
            dtemp=d;  % ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¡
        end
    end  
    

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½Ëºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [Zout1] = recalcula(cluster, data, Z) %ÎªÃ¿ï¿½ï¿½ï¿½ï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    Zout1=zeros(size(Z));
	for m=1:size(Z,1)
        index=find(cluster==m);
        if isempty(index)==0
            sindex=size(index,2);
            Zout1(m,:)=(sum(data(index,:),1)) / sindex;      
        else
            Zout1(m,:)=Z(m,:);
        end
    end
    

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½ï¿½ï¿½Ã¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Äµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ë£¬ï¿½Üµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ë£¬ï¿½ï¿½×¼Æ«ï¿½ï¿½ï¿½ï¿½ï¿½Ä·ï¿½ï¿½ï¿½ %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [Ditemp, Dtemp, STMAX] = dispersion(data, Z, cluster)
    A=size(Z,1);
    Ditemp=zeros(A,1);
    Dtemp=zeros(1,1);
    STMAX=zeros(1,A);
    for i=1:A
        suma=0;
        index=find(cluster==i);
        sindex=size(index,2);
        for j=index
            P=data(j,:);
            d=distancia(Z(i,:), P);% ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Xiï¿½ï¿½Ziï¿½Ä¾ï¿½ï¿½ï¿½.
            suma=suma + d;   % sumax
        end
        % ï¿½ï¿½É¢ï¿½ï¿½Èºï¿½ï¿½
        Ditemp(i,:)=suma / sindex;
        % È«ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½É¢
        Dtemp=Dtemp + (Ditemp(i,:) * sindex);% ï¿½Üºï¿½ Ni*Di
        %ï¿½ï¿½É¢ï¿½Ä±ï¿½ï¿½ï¿½
        ST=std(data(index,:));
        % ï¿½ï¿½É¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
        STMAX(i)=max(ST);
    end
    % È«ï¿½Ö·ï¿½É¢ï¿½ï¿½ï¿?
    Dtemp=Dtemp / size(data,1);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%   ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ°ï¿½Ò¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [Ztemp, clustertemp]=eliminar(cluster, Z, data, ON)
	%ï¿½ï¿½ï¿½ï¿½
    %Î»ï¿½Æ£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
    A=size(Z,1);
	desplazamiento=zeros(1,A);  % ï¿½ï¿½ï¿½ï¿½Üµï¿½Öµï¿½ï¿?: -1, (=0) ï¿½ï¿½ (>0).
	for i=1:A                  % Si -1: É¾ï¿½ï¿½ï¿½ï¿½ï¿½é¡£ï¿½ï¿½ï¿? 0: ï¿½ï¿½ï¿½ï¿½Ä±ï¿?
        cont=find(cluster==i);  % Si >0: ï¿½ï¿½È¥ï¿½ï¿½ï¿½ï¿½ï¿½Ü¶ï¿½ï¿½Î»ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½ï¿½Ö?.
        scont=size(cont,2);        
        if scont < ON
            desplazamiento(i)=-1;
            if  i < A
                for j=(i+1):A
                    desplazamiento(j)=desplazamiento(j)+1;
                end
            end   
        end
    end
	%ï¿½ï¿½ï¿½ï¿½
    [Ztemp, clustertemp]=reduce(desplazamiento, cluster, Z);
	% ï¿½ï¿½ï¿½Ä·ï¿½ï¿½äµ½ï¿½ï¿½Ä¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
    if isempty(Ztemp)==1  % ï¿½ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Èºï¿½å¡?
        Ztemp=median(data,1);
    end
	vacio=find(clustertemp==0);
	if  isempty(vacio)==0
        for i=vacio
            clustertemp(i)=cercano(data(i,:), Ztemp);
        end
    end
 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½ï¿½ï¿½ï¿½Êµï¿½ï¿½Ä¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Âµï¿½Ö?  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [clustertemp, Ztemp]=union(orden, cluster, Z, Dij)
    A=size(Z,1);
    clustertemp=cluster;
    sorden=size(orden,2);
    unidos=0;
    uindex=0;
    marca=zeros(1,A);
    for i=1:sorden
        yaunido=0;
        temp=[0 0];
        [fcnum(1),fcnum(2)]=find(Dij==orden(i)); %   fcnum(1) < fcnum(2)
        for j=1:2
            if isempty(find(unidos==fcnum(j)))==0
                yaunido=1;
            else
                temp(j)=fcnum(j);
            end
        end        
        if yaunido==0
            for h=1:2  
                unidos(uindex+1)=temp(h);
            end
            marca(fcnum(2))=-1;
            selec=find(clustertemp==fcnum(2));   % Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½RESPï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é¡£ï¿½ï¿½ï¿½y
            clustertemp(selec)=fcnum(1);         % ï¿½ï¿½ï¿½ï¿½ï¿½Ë¸ï¿½ï¿½ÔµÄ¼ï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½Ð¡ï¿½ï¿½ï¿½ï¿?.
        end
    end
    
    adicion=0;  %ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê½ï¿½ï¿½ï¿½ï¿½Ï¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½'ï¿½ï¿½ï¿?'ï¿½ï¿½
    for i=1:A
        if  marca(i) >= 0
            marca(i)=marca(i)+adicion;
        else
            adicion=adicion+1;
        end
    end
    % ï¿½ï¿½ï¿½Ù£ï¿½ï¿½ï¿½ï¿½Ð±ï¿½Òªï¿½ï¿½Ñ§Ï°ï¿½ï¿½Ä¿ï¿½ï¿½ï¿½Òµï¿½ï¿½ï¿½Èºï¿½ï¿½
    [Ztemp,clustertemp]=reduce(marca, clustertemp, Z);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Äºï¿½ï¿½ï¿½ï¿½ï¿½  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [Ztemp, clustertemp]=reduce(desplazamiento, cluster, Z)
    clustertemp=cluster;
    Ztemp=find(size(Z,1)==999999);    
    for i=1:size(Z,1)
        if  (desplazamiento(i) < 0)
            selec=find(cluster==i);
            if isempty(selec)==0
                clustertemp(selec)=0;
            end
        else
            Ztemp( (i-desplazamiento(i)), :)= Z(i,:);
            selec=find(clustertemp==i);
            clustertemp(selec)=clustertemp(selec)-desplazamiento(i);
        end
    end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Äºï¿½ï¿½Ôµï¿½ï¿½ï¿½Ë³ï¿½ï¿½ï¿½ï¿½Ì¾ï¿½ï¿½ï¿½%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [orden, Dij]= distancia_centros(Z, OC, L)
    A=size(Z,1);
    Dij=zeros((A-1),A);
    %ï¿½ï¿½ï¿½ï¿½Ö®ï¿½ï¿½Ä¾ï¿½ï¿½ï¿½ï¿½ï¿½ã¡£
    for i=1:(A-1)
        for j=(1+i):A
            Dij(i,j)=distancia(Z(i,:), Z(j,:));
        end
    end
    
    %ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½OCÐ¡ï¿½ï¿½
    index= find((Dij>0) & (Dij<OC))';
    if (isempty(index)==0)
        orden=sort(Dij(index));
        sorden=size(orden,2);
        if sorden>L
            orden=orden(1,1:L);
        end
    else
        orden=0;
    end

    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½ï¿½Ñ¾ï¿½ï¿½ï¿½  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [Ztemp, clustertemp]=dividir(ST, cluster, Z, ncentro, data)
    clustertemp=cluster;
    Ztemp=Z;
    k2=0.5;          % 0 < k2 < 1
    Yi=ST(ncentro) * k2;
    Atemp=size(Z,1)+1;
    Ztemp(Atemp,:)=Ztemp(ncentro,:);         % ï¿½ï¿½Èºï¿½ï¿½ï¿½ï¿½
    m=find(Ztemp(ncentro,:)==max(Ztemp(ncentro,:)));    % Ð­ï¿½ï¿½Ö¸ï¿½ï¿½Ï¸ï¿?
    Ztemp(ncentro,m)=Ztemp(ncentro,m)+Yi;  % Z+=Z(ncentro)
    Ztemp(Atemp,m)=Ztemp(Atemp,m)-Yi;      % Z-=Z(Atemp)
    dividendo= find(clustertemp==ncentro);
    for i=(dividendo)
        P=data(i,:);
        if  (distancia( P, Ztemp(ncentro,:) )) >= (distancia(P, Ztemp(Atemp,:)))  %d(Z+) >= d(Z-)
            clustertemp(i)=Atemp;
        end
    end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö®ï¿½ï¿½Ä¾ï¿½ï¿½ï¿?  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [dist]= distancia(Z1, Z2)
%     dist=sqrt( ((Z1(1)-Z2(1))^2) + ((Z1(2)-Z2(2))^2) );% ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö®ï¿½ï¿½Ä¾ï¿½ï¿½ï¿?.
    dist = 1-(Z1*Z2')/sqrt((Z1*Z1')*(Z2*Z2'));
          
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿½Ã³ï¿½ï¿½ï¿½ï¿½ï¿½Ä»ï¿½ï¿½ï¿½ï¿½ï¿½Ñ­ï¿½ï¿½ï¿½ï¿½Ò»Ð©ï¿½ï¿½ï¿½ï¿?  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [itertemp,FINtemp,vuelve3temp]= termina_o_itera(iter, I, NO)
    itertemp=iter;
    FINtemp=0;
    vuelve3temp=1;
    if itertemp==I
        FINtemp=1;
    else
        if NO==1
            vuelve3temp=1;    
        else
            preg2=find(iter==0); % Resp. vacia
            fprintf('\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n');
            fprintf('ï¿½ï¿½Ç°ï¿½ï¿½ï¿? %d \n',itertemp);
            while (isempty(preg2)==1) | ( (preg2~=2) & (preg2~=1) ),
                fprintf('Òªï¿½ï¿½Ä£ï¿½È»ï¿½ó·µ»Øµï¿½ï¿½ï¿½ÎºÎ²ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½= 1ï¿½ï¿½ï¿½ï¿½= 2ï¿½ï¿½ \n ï¿½ï¿½');
                preg2=input('');
            end;
            if preg2==1
                vuelve3temp=0;  % ×ªï¿½ï¿½ï¿½ï¿½2ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸Ä²ï¿½ï¿½ï¿½
            else
                vuelve3temp=1;  % ×ªï¿½ï¿½ï¿½ï¿½3ï¿½ï¿½
            end;
        end;
        itertemp=itertemp+1;
    end;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
%  ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½Ç°ï¿½ï¿½ï¿½ï¿½8ï¿½ï¿½7  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [nexttemp]=decide78(iter, k, A)
    nexttemp=0;
    if A <= (k/2)
        nexttemp=1;     % ×ªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½7.
    end
    if ( (A>=(2*k)) || ( (iter>0) && (((iter+1)/2)>(ceil(iter/2)))) )   % ï¿½ï¿½ï¿? a>=2k ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿?
        nexttemp=2;     % ×ªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 8.
    end
    if nexttemp==0
        nexttemp=1;
    end
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
function [Z]=inicializa_centros(data, k)
    % ï¿½ï¿½ï¿½È·Ö²ï¿½ï¿½ï¿½ï¿½ï¿½
    dx= (max(data))-(min(data));
    dzx= dx/(k+1);    % Ð­ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö®ï¿½ï¿½Ä¾ï¿½ï¿½ï¿? X.
    for i=1:k
        Z(i,:)=min(data)+(dzx*i);
    end